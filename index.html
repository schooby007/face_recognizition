<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Attendance System</title>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@latest/dist/face-api.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .section { margin: 20px; }
        video, canvas { border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>Student Attendance System</h1>
    
    <div class="section">
        <h2>Enroll Student</h2>
        <input type="text" id="studentName" placeholder="Enter student name">
        <button onclick="enrollStudent()">Enroll</button>
    </div>
    
    <div class="section">
        <h2>Mark Attendance</h2>
        <button onclick="markAttendance()">Scan and Mark Present</button>
    </div>
    
    <div class="section">
        <video id="video" width="320" height="240" autoplay muted></video>
        <canvas id="canvas" width="320" height="240" style="display: none;"></canvas>
    </div>
    
    <pre id="output"></pre>

    <script>
        // TODO: Replace with your own values
        const CLIENT_ID = '<YOUR_CLIENT_ID>'; // From Google Cloud Console
        const API_KEY = '<YOUR_API_KEY>'; // From Google Cloud Console
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        const SPREADSHEET_ID = '<YOUR_SPREADSHEET_ID>'; // ID of your Google Sheet
        const SHEET_NAME = 'Sheet1'; // Name of the sheet to append to

        // Download models from https://github.com/justadudewhohacks/face-api.js-models and place in a /models folder in the same directory as this HTML file.
        const MODEL_URL = '/models';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let video;
        let canvas;
        let output;

        async function startVideo() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            output = document.getElementById('output');
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                })
                .catch(err => {
                    console.error('Error accessing camera:', err);
                    output.textContent = 'Error accessing camera: ' + err;
                });
        }

        async function loadModels() {
            try {
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                output.textContent += '\nModels loaded successfully.';
            } catch (err) {
                console.error('Error loading models:', err);
                output.textContent = 'Error loading models: ' + err;
            }
        }

        function captureImage() {
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, 320, 240);
            return canvas;
        }

        async function getFaceDescriptor(image) {
            const detection = await faceapi.detectSingleFace(image).withFaceLandmarks().withFaceDescriptor();
            if (!detection) {
                throw new Error('No face detected');
            }
            return detection.descriptor;
        }

        function saveStudent(name, descriptor) {
            let students = JSON.parse(localStorage.getItem('students')) || [];
            const existing = students.find(s => s.name === name);
            if (existing) {
                existing.descriptors.push(Array.from(descriptor));
            } else {
                students.push({ name, descriptors: [Array.from(descriptor)] });
            }
            localStorage.setItem('students', JSON.stringify(students));
        }

        async function enrollStudent() {
            const name = document.getElementById('studentName').value.trim();
            if (!name) {
                output.textContent = 'Enter a student name.';
                return;
            }
            try {
                const image = captureImage();
                const descriptor = await getFaceDescriptor(image);
                saveStudent(name, descriptor);
                output.textContent = `Enrolled ${name} successfully.`;
            } catch (err) {
                output.textContent = 'Error enrolling: ' + err;
            }
        }

        function getLabeledDescriptors() {
            const students = JSON.parse(localStorage.getItem('students')) || [];
            return students.map(s => 
                new faceapi.LabeledFaceDescriptors(s.name, s.descriptors.map(d => new Float32Array(d)))
            );
        }

        async function markAttendance() {
            try {
                const image = captureImage();
                const queryDescriptor = await getFaceDescriptor(image);
                const labeledDescriptors = getLabeledDescriptors();
                if (labeledDescriptors.length === 0) {
                    output.textContent = 'No students enrolled.';
                    return;
                }
                const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors);
                const bestMatch = faceMatcher.findBestMatch(queryDescriptor);
                if (bestMatch.distance > 0.6) { // Threshold for match
                    output.textContent = 'No match found.';
                    return;
                }
                const name = bestMatch.label;
                const date = new Date().toLocaleDateString();
                output.textContent = `Marked ${name} present on ${date}.`;
                await appendToSheet(name, date);
            } catch (err) {
                output.textContent = 'Error marking attendance: ' + err;
            }
        }

        async function appendToSheet(name, date) {
            if (!gapi.client.sheets) {
                throw new Error('Google API not initialized');
            }
            const response = await gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: SPREADSHEET_ID,
                range: SHEET_NAME,
                valueInputOption: 'USER_ENTERED',
                resource: {
                    values: [[name, date]]
                }
            });
            console.log('Appended:', response);
        }

        // Google API functions from quickstart, adapted
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                // You can add a button for auth if needed, but for simplicity, auth on mark
            }
        }

        async function handleAuth() {
            return new Promise((resolve, reject) => {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        reject(resp);
                    }
                    resolve();
                };
                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    tokenClient.requestAccessToken({prompt: ''});
                }
            });
        }

        // Wrap appendToSheet with auth
        const originalAppend = appendToSheet;
        appendToSheet = async function(name, date) {
            try {
                await handleAuth();
            } catch (err) {
                output.textContent = 'Auth error: ' + JSON.stringify(err);
                return;
            }
            await originalAppend(name, date);
        }

        // Initialize
        async function init() {
            await loadModels();
            startVideo();
        }
        init();

        // For demonstration:
        // 1. Download face-api.js models and place in /models folder.
        // 2. Set up Google Cloud project as per https://developers.google.com/workspace/sheets/api/quickstart/js
        // 3. Replace placeholders with your CLIENT_ID, API_KEY, SPREADSHEET_ID.
        // 4. Create a Google Sheet with headers like "Name" and "Date".
        // 5. Enroll students using their faces via camera.
        // 6. Mark attendance by scanning faces.
        // No additional file types needed beyond the models (JSON and bin files from download) and this HTML.
    </script>
</body>
</html>
